<head>
    <meta charset="utf-8">

    <title>Week12 API 留言板</title>
    <meta name='viewport' content="width=device-width, initial-scale=1">
    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
    <link rel='stylesheet' href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
    </style>
    <script>
        function escape(toOutput){
            return toOutput.replace(/\&/g, '&amp;')
                .replace(/\</g, '&lt;')
                .replace(/\>/g, '&gt;')
                .replace(/\"/g, '&qout;')
                .replace(/\'/g, '&#x27')
                .replace(/\//g, '&#x2f');
        }

        function appendCommentToDOM(container, comment, isPrepend) {
            const html = `<div class="card mt-2" >
                            <div class="card-body">
                            <h5 class="card-title">${escape(comment.nickname)}</h5>
                            <p class="card-text">${escape(comment.content)}</p>
                            </div>
                        </div>
                        `
            if (isPrepend) {
                container.prepend(html)
            } else {
                container.append(html)
            }
        }

        
        $(document).ready(() => {
            const commentDOM = $('.comments')
            let commentsCount = 0
            let commentsNow = 0
            $.ajax({
                url: "http://mentor-program.co/mtr04group1/s22shadowl/week12/board/api_comments.php?site_key=s22shadowl",
                }).done(function(data) {
                if (!data.ok) {
                    alert(data.message)
                    return
                }
                const comments = data.discussions
                commentsCount = comments.length
                commentsNow += 5
                for (let i = 0 ; i < 5 ; i++ ) {
                    appendCommentToDOM(commentDOM, comments[i])
                }
            });

            $('.add-comment-form').submit( e => {
                e.preventDefault()
                const newCommentData = {
                    site_key: 's22shadowl',
                    nickname: $('input[name=nickname]').val(),
                    content: $('textarea[name=content]').val()
                }
                $.ajax({
                    type: 'POST',
                    url: 'http://mentor-program.co/mtr04group1/s22shadowl/week12/board/api_add_comment.php',
                    data: newCommentData
                }).done(function(data) {
                    if (!data.ok) {
                        alert(data.message)
                        return
                    }
                    $('input[name=nickname]').val('')
                    $('textarea[name=content]').val('')
                    appendCommentToDOM(commentDOM, newCommentData, true)
                })
            })
            $('.showmore-btn').click( e => {
                $.ajax({
                    url: "http://mentor-program.co/mtr04group1/s22shadowl/week12/board/api_comments.php?site_key=s22shadowl",
                    }).done(function(data) {
                        if (!data.ok) {
                            alert(data.message)
                            return
                        }
                        const comments = data.discussions
                        let commentsShow = commentsNow + 5
                        if ( commentsNow + 5 > commentsCount ) {
                            commentsShow = commentsCount
                            $('.showmore-btn').hide()  
                        }
                        for (let i = commentsNow ; i < commentsShow ; i++ ) {
                            appendCommentToDOM(commentDOM, comments[i])
                        }
                        commentsNow += 5
                });
                console.log(commentsNow)
                console.log(commentsCount)
            })

        })
    </script>
</head>
<body>
    <div class='container'>
        <form class='add-comment-form'>
            <div class="form-group">
                <label for="form-nickname">暱稱</label>
                <input type="text" class="form-control" name="nickname" >
              </div>
            <div class="form-group">
                <label for="content-textarea" class="form-label">留言內容</label>
                <textarea class="form-control" rows="3" name="content"></textarea>
            </div>
            <button type="submit" class="btn btn-primary mt-2">送出</button>
        </form>
        <div class='comments'>
            
        </div>
        <div class='btn btn-primary showmore-btn mt-2'>載入更多</div>
    </div>
</body>